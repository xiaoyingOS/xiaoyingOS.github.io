<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«ç è¯†åˆ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 3px;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }
        
        /* .main-content {
            
        } */
        
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .action-area {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            justify-content: center;
            align-items: flex-start;
        }
        
        .preview-area {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px;
            width: 300px;
            height: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }
        
        .preview-content {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        
        .preview-placeholder {
            text-align: center;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .preview-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .preview-image {
            max-width: 160px;
            max-height: 160px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            object-fit: contain;
            vertical-align: middle;
        }
        
        .image-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .scan-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            width: 120px;
            margin-bottom: 0;
            margin-right: 120px;
        }
        
        .title-section {
            color: white;
        }
        
        .title {
            font-size: 2.5rem;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .scan-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 500;
        }
        
        .scan-button:hover {
            background: white;
            transform: translateY(-2px);
        }
        
        .scan-button:active {
            transform: translateY(-1px);
        }
        
        .upload-section {
            display: none;
        }
        
        .upload-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .upload-button:hover {
            background: white;
            transform: translateY(-2px);
        }
        
        .upload-button:active {
                    transform: translateY(-1px);
                }
        
                .result-section {

                            background: rgba(255, 255, 255, 0.9);

                            padding: 20px 3px 20px 3px;

                            margin-bottom: 20px;

                        }                .result-header {
                            margin-bottom: 10px;
                            padding-left: 0;
                        }                .result-header h3 {
                            color: #333;
                            font-size: 1.2rem;
                        }
                        
                        .result-actions {

                                    display: flex;

                                    gap: 8px;

                                    margin-bottom: 15px;

                                    align-items: stretch;

                                    flex-wrap: nowrap;

                                    justify-content: center;

                                }.action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            height: 32px;
            box-sizing: border-box;
        }                .action-button:hover {
                    transform: translateY(-1px);
                }
        
                .action-button:active {
                    transform: translateY(0);
                }
        
                .result-content {

                            background: white;

                            padding: 15px;

                            min-height: 300px;

                            max-height: 500px;

                            border: 1px solid #e0e0e0;

                            border-radius: 4px;

                            font-size: 1rem;

                            line-height: 1.5;

                            color: #333;

                            white-space: pre-wrap;

                            word-wrap: break-word;

                            overflow-y: auto;

                            overflow-x: auto;

                        }                .result-placeholder {
                    color: #999;
                    font-style: italic;
                }
        
                .history-section {

                            background: rgba(255, 255, 255, 0.9);

                            padding: 20px 3px 20px 3px;

                        }                .history-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                            padding-left: 0;
                        }
                
                        .history-header h3 {
                            color: #333;
                            font-size: 1.2rem;
                        }        
                .history-content {
                    background: white;
                    padding: 15px;
                    min-height: 150px;
                    border: 1px solid #e0e0e0;
                    border-radius: 4px;
                }
        
                .history-placeholder {
                    color: #999;
                    font-style: italic;
                }
        
                .history-item {
                            border-bottom: 1px solid #f0f0f0;
                        }
                
                        .history-item:last-child {
                            border-bottom: none;
                        }
                
                        .history-header {
                            display: flex;
                            align-items: center;
                            padding: 10px;
                            cursor: pointer;
                            transition: background-color 0.2s;
                        }
                
                        .history-header:hover {
                            background-color: rgba(102, 126, 234, 0.05);
                        }
                
                        .history-toggle {
                            color: #667eea;
                            font-weight: bold;
                            margin-right: 8px;
                            transition: transform 0.2s;
                            display: inline-block;
                            width: 16px;
                            text-align: center;
                        }
                
                        .history-preview {
                            flex: 1;
                            word-wrap: break-word;
                            margin-right: 10px;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            font-size: 0.9rem;
                        }
                
                        .history-time {
                            color: #666;
                            font-size: 0.8rem;
                            white-space: nowrap;
                        }
                
                        .history-content-detail {
                            display: none;
                            padding: 0 10px 10px 34px;
                            border-top: 1px solid #f8f8f8;
                            background-color: rgba(102, 126, 234, 0.02);
                        }
                
                        .history-full-text {
                            word-wrap: break-word;
                            font-size: 0.9rem;
                            line-height: 1.4;
                            color: #333;
                            max-height: 200px;
                            overflow-y: auto;
                            padding: 8px;
                            background: white;
                            border-radius: 4px;
                            border: 1px solid #e8e8e8;
                        }                .scan-modal {            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .scan-modal.active {
            display: flex;
        }
        
        .scan-header {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scan-header h2 {
            font-size: 1.2rem;
        }
        
        .close-scan {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .close-scan:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .scan-video-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #scan-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            pointer-events: none;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .scan-tips {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .scan-controls {
            position: absolute;
            top: 80px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }
        
        .scan-control-btn {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
        }
        
        .scan-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .scan-control-btn:active {
            transform: scale(0.95);
        }
        
        .scan-control-btn.active {
            background: rgba(102, 126, 234, 0.8);
        }
        
        .scan-method-selector {
            position: absolute;
            top: 80px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 0.8rem;
            z-index: 10;
        }
        
        .scan-method-title {
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .scan-method-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .scan-method-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .scan-method-option.active {
            background: rgba(102, 126, 234, 0.3);
        }
        
        .scan-method-option input[type="radio"] {
            margin: 0;
        }
        
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .upload-modal.active {
            display: flex;
        }
        
        .upload-content {
            background: white;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .upload-header h2 {
            color: #333;
            font-size: 1.5rem;
        }
        
        .close-upload {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .close-upload:hover {
            background: #f0f0f0;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            padding: 40px 20px;
            text-align: center;
            background-color: rgba(102, 126, 234, 0.05);
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .upload-area.dragover {
            background-color: rgba(102, 126, 234, 0.2);
            border-color: #764ba2;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        .upload-button:hover {
            transform: translateY(-2px);
        }
        
        .preview-container {
            margin-top: 20px;
            text-align: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            margin-bottom: 15px;
        }
        
        .preview-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .preview-button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .analyze-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .reset-button {
            background: #6c757d;
            color: white;
        }
        
        .preview-button:hover {
            transform: translateY(-2px);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: -100%;
            padding: 10px 10px 10px 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all 0.4s ease-out;
            border-radius: 8px;
            box-shadow: -6px 6px 20px rgba(0, 0, 0, 0.25), -3px 3px 10px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 150px;
            max-width: 250px;
            text-align: left;
        }
        
        .toast.show {
            right: 3px;
            opacity: 1;
            transition-delay: 0.1s;
        }
        
        .toast.success {
            background: linear-gradient(135deg, #00b894, #00cec9, #74b9ff);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24, #feca57);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* æ–°å¢æ¡å½¢ç æ ¼å¼æ ‡ç­¾æ ·å¼ */
        .format-badge {
            display: inline-block;
            padding: 4px 8px;
            margin-left: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 0.75rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        
        
        .format-badge.barcode {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .format-badge.qrcode {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        }
        
        /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘é‡ç»˜ */
        .gpu-accelerated {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        @media (max-width: 768px) {
            .action-area {
                flex-direction: row;
                align-items: flex-start;
                gap: 10px;
                justify-content: flex-end;
            }
            
            .preview-area {
                width: 200px;
                height: 170px;
            }
            
            .preview-content {
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .preview-image {
                max-width: 140px;
                max-height: 140px;
            }
            
            .button-container {
                width: 120px;
                flex-direction: column;
                justify-content: center;
                margin-left: auto;
                margin-right: 13px;
                margin-bottom: 15px;
                gap: 0;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .scan-method-selector {
                left: 5px;
                font-size: 0.7rem;
                padding: 8px;
            }
            
            .scan-controls {
                right: 5px;
            }
            
            .scan-control-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .upload-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <header class="header">
                        <div class="title-section">
                            <h1 class="title">æ‰«ç è¯†åˆ«</h1>
                            <p class="subtitle">å¤šå¼•æ“å…¨å±æ‰«æï¼Œå‡†ç¡®è¯†åˆ«äºŒç»´ç å’Œæ¡å½¢ç å†…å®¹</p>
                        </div>
                    </header>
                            
                            <!-- æ“ä½œåŒºåŸŸå®¹å™¨ -->
                            <div class="action-area">
                                <!-- é¢„è§ˆå®¹å™¨ -->
                                            <div class="preview-area">
                                                <div class="preview-content" id="preview-content">
                                                    <div class="preview-placeholder">
                                                        <div class="preview-icon">ğŸ“·</div>
                                                        <p>é¢„è§ˆåŒº</p>
                                                    </div>
                                                </div>
                                            </div>                                
                                <!-- æŒ‰é’®å®¹å™¨ -->
                                <div class="button-container">
                                    <button class="scan-button" onclick="openScanModal()">
                                        [â€”] æ‰«ä¸€æ‰«
                                    </button>
                                    <button class="upload-button" onclick="openUploadModal('file')">
                                        ğŸ“ ä¸Šä¼ æ–‡ä»¶
                                    </button>
                                    <button class="upload-button" onclick="openUploadModal('image')">
                                        ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡
                                    </button>
                                </div>
                            </div>
                            
                            <!-- è¯†åˆ«ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->            
            <section class="result-section">
            <div class="result-header">
                <h3>è¯†åˆ«ç»“æœ <span id="result-format" class="format-badge" style="display: none;"></span></h3>
            </div>
            <div class="result-actions">
                <button class="action-button" onclick="clearResult()">ğŸ—‘ï¸ æ¸…é™¤</button>
                <button class="action-button" onclick="undoResult()">â†¶ æ’¤é”€</button>
                <button class="action-button" onclick="redoResult()">â†· åæ’¤é”€</button>
                <button class="action-button" onclick="copyResult()">ğŸ“‹ å¤åˆ¶</button>
            </div>
            <div class="result-content" id="result-content">
                <p class="result-placeholder">æš‚æ— è¯†åˆ«ç»“æœ</p>
            </div>
        </section>
        
        <!-- è¯†åˆ«å†å²åŒºåŸŸ -->
        <section class="history-section">
            <div class="history-header">
                <h3>è¯†åˆ«å†å²</h3>
                <button class="action-button" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div class="history-content" id="history-content">
                <p class="history-placeholder">æš‚æ— è¯†åˆ«å†å²</p>
            </div>
        </section>
        </div>
    </div>
    
    <!-- æ‰«ææ¨¡æ€æ¡† -->
    <div id="scan-modal" class="scan-modal">
        <div class="scan-header">
            <h2 id="scan-title">å…¨å±æ‰«ç </h2>
            <button class="close-scan" onclick="closeScanModal()">âœ•</button>
        </div>
        <div class="scan-video-container">
            <video id="scan-video" autoplay playsinline></video>
            <div class="scan-overlay">
                <div class="scan-line"></div>
            </div>
            
            <!-- æ‰«ææ§åˆ¶æŒ‰é’® -->
            <div class="scan-controls">
                <button class="scan-control-btn" onclick="flipCamera()" title="ç¿»è½¬æ‘„åƒå¤´">
                    ğŸ”„
                </button>
                <button class="scan-control-btn" onclick="toggleFlash()" title="é—ªå…‰ç¯">
                    ğŸ’¡
                </button>
                <button class="scan-control-btn" onclick="toggleMirror()" title="é•œåƒç¿»è½¬">
                    ğŸª
                </button>
                <button class="scan-control-btn" id="batch-scan-btn" onclick="startBatchScan()" title="æ‰¹é‡è¯†åˆ«">
                    ğŸ“š
                </button>
                <button class="scan-control-btn" onclick="selectImageFromScan()" title="é€‰æ‹©å›¾ç‰‡">
                    ğŸ–¼ï¸
                </button>
                <button class="scan-control-btn" onclick="selectFileFromScan()" title="é€‰æ‹©æ–‡ä»¶">
                    ğŸ“
                </button>
                <button class="scan-control-btn" onclick="testScanEngines()" title="æµ‹è¯•æ‰€æœ‰å¼•æ“">
                    ğŸ§ª
                </button>
            </div>
            
            <!-- æ‰«ææ–¹æ³•é€‰æ‹©å™¨ -->
            <div class="scan-method-selector">
                <div class="scan-method-title">æ‰«æå¼•æ“</div>
                <div class="scan-method-option active">
                    <input type="radio" name="scan-method" value="native" checked onchange="changeScanMethod('native')">
                    <label>åŸç”ŸAPI</label>
                </div>
                <div class="scan-method-option">
                    <input type="radio" name="scan-method" value="zxing" onchange="changeScanMethod('zxing')">
                    <label>Zxing</label>
                </div>
                <div class="scan-method-option">
                    <input type="radio" name="scan-method" value="jsqr" onchange="changeScanMethod('jsqr')">
                    <label>jsQR</label>
                </div>
            </div>
            
            <div class="scan-tips" id="scan-tips">å…¨å±æ‰«ææ¨¡å¼ - å°†äºŒç»´ç å¯¹å‡†å±å¹•ä»»æ„ä½ç½®</div>
            
            <!-- æƒé™è¯·æ±‚åŒºåŸŸ -->
            <div id="permission-area" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; z-index: 20;">
                <div style="background: rgba(0,0,0,0.8); padding: 30px; border-radius: 10px; max-width: 300px;">
                    <h3 style="margin-bottom: 15px;">éœ€è¦æ‘„åƒå¤´æƒé™</h3>
                    <p style="margin-bottom: 20px; font-size: 0.9rem;">è¯·å…è®¸è®¿é—®æ‘„åƒå¤´ä»¥ä½¿ç”¨æ‰«æåŠŸèƒ½</p>
                    <button onclick="requestCameraPermission()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 1rem;">
                        æˆæƒæ‘„åƒå¤´
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="upload-modal" class="upload-modal">
        <div class="upload-content">
            <div class="upload-header">
                <h2 id="upload-title">ä¸Šä¼ æ–‡ä»¶</h2>
                <button class="close-upload" onclick="closeUploadModal()">âœ•</button>
            </div>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“</div>
                <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">æ”¯æŒ JPG, PNG, GIF, BMP æ ¼å¼</p>
                <input type="file" id="file-input" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
                <button class="upload-button" onclick="document.getElementById('file-input').click()">é€‰æ‹©æ–‡ä»¶</button>
            </div>
            
            <div id="preview-container" class="preview-container hidden">
                <img id="preview-image" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                <div class="preview-controls">
                    <button class="preview-button analyze-button" onclick="analyzeImage()">è¯†åˆ«äºŒç»´ç /æ¡å½¢ç </button>
                    <button class="preview-button reset-button" onclick="resetUpload()">é‡æ–°é€‰æ‹©</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>
    
    <!-- ä¸´æ—¶æ‰«æåŒºåŸŸï¼ˆéšè—ï¼‰ -->
    <div id="temp-scan-area" style="position: absolute; left: -9999px; width: 300px; height: 300px;"></div>
    
    <!-- æ‰«ææ¨¡æ€æ¡†å†…çš„æ–‡ä»¶è¾“å…¥ï¼ˆéšè—ï¼‰ -->
    <input type="file" id="scan-image-input" class="file-input" accept="image/*" onchange="handleScanImageSelect(event)" style="display: none;">
    <input type="file" id="scan-file-input" class="file-input" accept="image/*" onchange="handleScanFileSelect(event)" style="display: none;">

    <!-- å¼•å…¥å¤šä¸ªæ‰«æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

    <script>
        let scanVideo = document.getElementById('scan-video');
        let scanCanvas = document.createElement('canvas');
        let scanContext = scanCanvas.getContext('2d');
        let scanning = false;
        let currentScanMethod = 'native';
        let currentCamera = 'environment';
        let flashState = false;
        let zxingScanner = null;
        let mirrorState = false;
        let barcodeMode = false; // æ–°å¢ï¼šæ¡å½¢ç æ¨¡å¼æ ‡å¿—
        let batchScanResults = []; // æ–°å¢ï¼šæ‰¹é‡æ‰«æç»“æœæ•°ç»„
        let batchScanning = false; // æ–°å¢ï¼šæ‰¹é‡æ‰«æçŠ¶æ€æ ‡å¿—
        let lastBatchScanTime = 0; // æ–°å¢ï¼šä¸Šæ¬¡æ‰¹é‡æ‰«æçš„æ—¶é—´
        const BATCH_SCAN_COOLDOWN = 2000; // æ‰¹é‡æ‰«æå†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        
        // å…¨å±€æ‰«æçŠ¶æ€ç®¡ç†
        let scanEngines = {
            jsqr: { active: false, stopFunction: null },
            zxing: { active: false, stopFunction: null },
            native: { active: false, stopFunction: null }
        };
        
        // å½“å‰æ´»è·ƒçš„æ‰«æå¼•æ“
        let activeEngine = null;
        
        // è¯†åˆ«ç»“æœå’Œå†å²ç›¸å…³å˜é‡
        let currentResult = '';
        let resultHistory = [];
        let undoStack = [];
        let redoStack = [];
        let currentFormat = ''; // æ–°å¢ï¼šå½“å‰è¯†åˆ«çš„ç æ ¼å¼
        
        // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ requestAnimationFrame èŠ‚æµ
        let lastScanTime = 0;
        const SCAN_THROTTLE = 100; // æ‰«æé—´éš”ï¼ˆæ¯«ç§’ï¼‰
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            loadHistory();
            checkBarcodeDetectorSupport();
            checkCameraSupport();
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šå¯ç”¨GPUåŠ é€Ÿ
            document.querySelectorAll('.scan-modal, .upload-modal, .toast').forEach(el => {
                el.classList.add('gpu-accelerated');
            });
        });
        
        // æ£€æŸ¥æ‘„åƒå¤´æ”¯æŒ
        async function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®');
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨', 'error');
                return;
            }
            
            try {
                // å°è¯•æšä¸¾æ‘„åƒå¤´è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    console.warn('æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡');
                    showToast('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡', 'error');
                } else {
                    console.log(`æ‰¾åˆ° ${videoDevices.length} ä¸ªæ‘„åƒå¤´è®¾å¤‡`);
                }
            } catch (error) {
                console.warn('æšä¸¾æ‘„åƒå¤´è®¾å¤‡å¤±è´¥:', error);
            }
        }
        
        // æ£€æŸ¥åŸç”Ÿæ¡ç æ£€æµ‹å™¨æ”¯æŒ
        function checkBarcodeDetectorSupport() {
            if ('BarcodeDetector' in window) {
                console.log('åŸç”ŸBarcodeDetector API æ”¯æŒ');
            } else {
                console.log('åŸç”ŸBarcodeDetector API ä¸æ”¯æŒ');
                // ç¦ç”¨åŸç”ŸAPIé€‰é¡¹
                const nativeOption = document.querySelector('input[value="native"]');
                if (nativeOption) {
                    nativeOption.disabled = true;
                    nativeOption.parentElement.style.opacity = '0.5';
                }
            }
        }
        
        // è¯·æ±‚æ‘„åƒå¤´æƒé™
        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: false 
                });
                
                // ç«‹å³å…³é—­æµï¼Œè¿™åªæ˜¯æƒé™æµ‹è¯•
                stream.getTracks().forEach(track => track.stop());
                
                // éšè—æƒé™è¯·æ±‚åŒºåŸŸ
                document.getElementById('permission-area').style.display = 'none';
                
                // å¯åŠ¨æ‘„åƒå¤´
                await startCamera(currentCamera);
                showToast('æ‘„åƒå¤´æƒé™å·²æˆæƒ', 'success');
                
            } catch (error) {
                let message = 'æ‘„åƒå¤´æƒé™è¯·æ±‚å¤±è´¥';
                
                if (error.name === 'NotAllowedError') {
                    message = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    message = 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡';
                }
                
                showToast(message, 'error');
                console.error('Permission request error:', error);
            }
        }
        
        // æ‰“å¼€æ‰«ææ¨¡æ€æ¡†
        async function openScanModal() {
            const modal = document.getElementById('scan-modal');
            modal.classList.add('active');
            
            // æ˜¾ç¤ºæƒé™è¯·æ±‚åŒºåŸŸ
            document.getElementById('permission-area').style.display = 'block';
            document.getElementById('scan-tips').style.display = 'none';
            
            // å°è¯•è‡ªåŠ¨å¯åŠ¨æ‘„åƒå¤´
            try {
                await startCamera(currentCamera);
                // å¦‚æœæˆåŠŸï¼Œéšè—æƒé™è¯·æ±‚åŒºåŸŸ
                document.getElementById('permission-area').style.display = 'none';
                document.getElementById('scan-tips').style.display = 'block';
            } catch (error) {
                console.log('è‡ªåŠ¨æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œæ˜¾ç¤ºæƒé™è¯·æ±‚:', error.message);
                // æ˜¾ç¤ºæƒé™è¯·æ±‚åŒºåŸŸï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨æˆæƒ
                showToast('è¯·ç‚¹å‡»"æˆæƒæ‘„åƒå¤´"æŒ‰é’®å¼€å§‹æ‰«æ', 'error');
            }
        }
        
        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera(facingMode = 'environment') {
            if (scanVideo.srcObject) {
                scanVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®åŠŸèƒ½');
            }
            
            let stream = null;
            
            try {
                // é¦–å…ˆå°è¯•ç†æƒ³é…ç½®
                const constraints = {
                    video: { 
                        facingMode: facingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (idealError) {
                    console.warn('ç†æƒ³é…ç½®å¤±è´¥ï¼Œå°è¯•åŸºæœ¬é…ç½®:', idealError);
                    
                    // å°è¯•åŸºæœ¬é…ç½®
                    const basicConstraints = {
                        video: { 
                            facingMode: facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                    
                    try {
                        stream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                    } catch (basicError) {
                        console.warn('åŸºæœ¬é…ç½®å¤±è´¥ï¼Œå°è¯•æœ€ç®€é…ç½®:', basicError);
                        
                        // å°è¯•æœ€ç®€é…ç½®
                        const minimalConstraints = {
                            video: true,
                            audio: false
                        };
                        
                        stream = await navigator.mediaDevices.getUserMedia(minimalConstraints);
                    }
                }
                
                if (!stream) {
                    throw new Error('æ— æ³•è·å–æ‘„åƒå¤´æµ');
                }
                
                scanVideo.srcObject = stream;
                scanVideo.setAttribute('playsinline', true);
                scanVideo.setAttribute('muted', true);
                
                // ç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆ
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('è§†é¢‘åŠ è½½è¶…æ—¶'));
                    }, 5000); // å‡å°‘è¶…æ—¶æ—¶é—´
                    
                    scanVideo.onloadedmetadata = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    
                    scanVideo.onerror = (error) => {
                        clearTimeout(timeout);
                        reject(error);
                    };
                });
                
                // å°è¯•æ’­æ”¾è§†é¢‘
                try {
                    await scanVideo.play();
                } catch (playError) {
                    console.warn('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’:', playError);
                    showToast('è¯·ç‚¹å‡»å±å¹•å¼€å§‹æ‰«æ', 'success');
                    
                    // æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨
                    scanVideo.addEventListener('click', async function playVideo() {
                        try {
                            await scanVideo.play();
                            scanVideo.removeEventListener('click', playVideo);
                            startScanning();
                            showToast('æ‰«æå·²å¼€å§‹', 'success');
                        } catch (error) {
                            console.error('æ‰‹åŠ¨æ’­æ”¾å¤±è´¥:', error);
                            showToast('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                        }
                    }, { once: true });
                    
                    return; // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»
                }
                
                // å¼€å§‹æ‰«æ
                startScanning();
                
            } catch (error) {
                // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'æ— æ³•è®¿é—®æ‘„åƒå¤´';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ‘„åƒå¤´è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'æ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„é…ç½®';
                } else if (error.name === 'TypeError') {
                    errorMessage = 'æ‘„åƒå¤´æƒé™è¯·æ±‚è¢«é˜»æ­¢';
                } else {
                    errorMessage = `æ‘„åƒå¤´è®¿é—®å¤±è´¥: ${error.message}`;
                }
                
                throw new Error(errorMessage);
            }
        }
        
        // åœæ­¢é™¤æŒ‡å®šå¼•æ“å¤–çš„æ‰€æœ‰å¼•æ“
        function stopAllEnginesExcept(exceptEngine) {
            Object.keys(scanEngines).forEach(engine => {
                if (engine !== exceptEngine && scanEngines[engine].active) {
                    console.log(`åœæ­¢å¼•æ“: ${engine}`);
                    if (scanEngines[engine].stopFunction) {
                        scanEngines[engine].stopFunction();
                    }
                }
            });
        }
        
        // å¼€å§‹æ‰«æ
        function startScanning() {
            scanning = true;
            
            switch (currentScanMethod) {
                case 'jsqr':
                    startJsQRScanning();
                    break;
                case 'zxing':
                    startZxingScanning();
                    break;
                case 'native':
                    startNativeScanning();
                    break;
                default:
                    startJsQRScanning();
            }
        }
        
        // æ£€æµ‹æ¡å½¢ç æ ¼å¼
        function detectBarcodeFormat(data) {
            if (!data) return '';
            
            // æ£€æµ‹å¸¸è§æ¡å½¢ç æ ¼å¼
            if (/^\d{12,13}$/.test(data)) {
                return data.length === 12 ? 'UPC-A' : 'EAN-13';
            }
            if (/^\d{8}$/.test(data)) {
                return 'EAN-8';
            }
            if (/^\d{7,8}$/.test(data) && /[0-9]{1}[0-9]{6}/.test(data)) {
                return 'UPC-E';
            }
            if (/^[0-9A-Z\-. $/+%]{1,48}$/.test(data)) {
                return 'Code 39';
            }
            if (/^[A-Za-z0-9!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~ ]+$/.test(data)) {
                return 'Code 128';
            }
            
            return 'QR Code';
        }
        
        // jsQRæ‰«æ - ä¼˜åŒ–ç‰ˆæœ¬
        function startJsQRScanning() {
            // é˜²æ­¢é‡å¤å¯åŠ¨
            if (scanEngines.jsqr.active) {
                console.log('jsQR å·²åœ¨è¿è¡Œä¸­');
                return;
            }
            
            console.log('å¯åŠ¨jsQRæ‰«æ');
            
            // åœæ­¢å…¶ä»–å¼•æ“
            stopAllEnginesExcept('jsqr');
            
            // ç¡®ä¿è§†é¢‘å…ƒç´ å¯è§
            scanVideo.style.display = 'block';
            
            // æ ‡è®°å¼•æ“ä¸ºæ´»è·ƒçŠ¶æ€
            scanEngines.jsqr.active = true;
            activeEngine = 'jsqr';
            
            let animationId = null;
            
            // å®šä¹‰åœæ­¢å‡½æ•°
            scanEngines.jsqr.stopFunction = function() {
                scanEngines.jsqr.active = false;
                if (activeEngine === 'jsqr') {
                    activeEngine = null;
                }
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                console.log('jsQR å·²åœæ­¢');
                return Promise.resolve();
            };
            
            function tick() {
                // ç¡®ä¿åªæœ‰å½“å‰æ´»è·ƒå¼•æ“ç»§ç»­è¿è¡Œ
                if (!scanEngines.jsqr.active || activeEngine !== 'jsqr') {
                    return;
                }
                
                // æ€§èƒ½ä¼˜åŒ–ï¼šèŠ‚æµæ‰«æ
                const now = Date.now();
                if (now - lastScanTime < SCAN_THROTTLE) {
                    animationId = requestAnimationFrame(tick);
                    return;
                }
                
                if (scanVideo.readyState === scanVideo.HAVE_ENOUGH_DATA) {
                    scanCanvas.width = scanVideo.videoWidth;
                    scanCanvas.height = scanVideo.videoHeight;
                    scanContext.drawImage(scanVideo, 0, 0, scanCanvas.width, scanCanvas.height);
                    
                    const imageData = scanContext.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        lastScanTime = now;
                        const format = detectBarcodeFormat(code.data);
                        handleScanResult(code.data, 'jsQR', format);
                        // åœ¨æ‰¹é‡æ‰«ææ¨¡å¼ä¸‹ä¸åœæ­¢æ‰«æ
                        if (!batchScanning) {
                            return;
                        }
                    }
                }
                
                animationId = requestAnimationFrame(tick);
            }
            
            tick();
        }
        
        // Zxingæ‰«æ - ä¼˜åŒ–ç‰ˆæœ¬
        function startZxingScanning() {
            // é˜²æ­¢é‡å¤å¯åŠ¨
            if (scanEngines.zxing.active) {
                console.log('Zxing å·²åœ¨è¿è¡Œä¸­');
                return;
            }
            
            console.log('å¯åŠ¨Zxingæ‰«æ');
            
            // åœæ­¢å…¶ä»–å¼•æ“
            stopAllEnginesExcept('zxing');
            
            // ç¡®ä¿è§†é¢‘å…ƒç´ å¯è§
            scanVideo.style.display = 'block';
            
            // æ ‡è®°å¼•æ“ä¸ºæ´»è·ƒçŠ¶æ€
            scanEngines.zxing.active = true;
            activeEngine = 'zxing';
            
            let scanInterval = null;
            
            // å®šä¹‰åœæ­¢å‡½æ•°
            scanEngines.zxing.stopFunction = function() {
                scanEngines.zxing.active = false;
                if (activeEngine === 'zxing') {
                    activeEngine = null;
                }
                if (scanInterval) {
                    clearInterval(scanInterval);
                    scanInterval = null;
                }
                console.log('Zxing å·²åœæ­¢');
                return Promise.resolve();
            };
            
            // ä½¿ç”¨å®šæ—¶å™¨åˆ†æè§†é¢‘å¸§ - å¢åŠ é—´éš”ä»¥æé«˜æ€§èƒ½
            scanInterval = setInterval(async () => {
                // ç¡®ä¿åªæœ‰å½“å‰æ´»è·ƒå¼•æ“ç»§ç»­è¿è¡Œ
                if (!scanEngines.zxing.active || activeEngine !== 'zxing') {
                    return;
                }
                
                // æ€§èƒ½ä¼˜åŒ–ï¼šèŠ‚æµæ‰«æ
                const now = Date.now();
                if (now - lastScanTime < SCAN_THROTTLE * 2) {
                    return;
                }
                
                if (scanVideo.readyState === scanVideo.HAVE_ENOUGH_DATA) {
                    try {
                        // æ•è·å½“å‰è§†é¢‘å¸§
                        scanCanvas.width = scanVideo.videoWidth;
                        scanCanvas.height = scanVideo.videoHeight;
                        scanContext.drawImage(scanVideo, 0, 0, scanCanvas.width, scanCanvas.height);
                        
                        // ä½¿ç”¨Zxingåˆ†æå›¾ç‰‡
                        const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(scanCanvas);
                        const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
                        const multiFormatReader = new ZXing.MultiFormatReader();
                        
                        try {
                            const result = multiFormatReader.decode(binaryBitmap);
                            if (result) {
                                lastScanTime = now;
                                const format = detectBarcodeFormat(result.text);
                                console.log('Zxing è¯†åˆ«æˆåŠŸ:', result.text, format);
                                handleScanResult(result.text, 'Zxing', format);
                            }
                        } catch (err) {
                            // é™é»˜å¤„ç†æœªæ‰¾åˆ°ç çš„æƒ…å†µ
                        }
                        
                    } catch (error) {
                        // é™é»˜å¤„ç†é”™è¯¯
                    }
                }
            }, 800); // å¢åŠ é—´éš”åˆ°800ms
            
            showToast('Zxing æ‰«æå·²å¯åŠ¨', 'success');
        }
        
        // åŸç”ŸAPIæ‰«æ - ä¼˜åŒ–ç‰ˆæœ¬
        async function startNativeScanning() {
            // é˜²æ­¢é‡å¤å¯åŠ¨
            if (scanEngines.native.active) {
                console.log('åŸç”ŸAPI å·²åœ¨è¿è¡Œä¸­');
                return;
            }
            
            if (!('BarcodeDetector' in window)) {
                showToast('æµè§ˆå™¨ä¸æ”¯æŒåŸç”ŸBarcodeDetector API', 'error');
                changeScanMethod('jsqr');
                return;
            }
            
            console.log('å¯åŠ¨åŸç”ŸAPIæ‰«æ');
            
            // åœæ­¢å…¶ä»–å¼•æ“
            stopAllEnginesExcept('native');
            
            // ç¡®ä¿è§†é¢‘å…ƒç´ å¯è§
            scanVideo.style.display = 'block';
            
            // æ ‡è®°å¼•æ“ä¸ºæ´»è·ƒçŠ¶æ€
            scanEngines.native.active = true;
            activeEngine = 'native';
            
            let animationId = null;
            
            // å®šä¹‰åœæ­¢å‡½æ•°
            scanEngines.native.stopFunction = function() {
                scanEngines.native.active = false;
                if (activeEngine === 'native') {
                    activeEngine = null;
                }
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                console.log('åŸç”ŸAPI å·²åœæ­¢');
                return Promise.resolve();
            };
            
            try {
                // æ ¹æ®æ¡å½¢ç æ¨¡å¼é€‰æ‹©æ”¯æŒçš„æ ¼å¼
                const formats = barcodeMode ? 
                    ['code_128', 'ean_13', 'ean_8', 'code_39', 'upc_a', 'upc_e', 'itf', 'codabar'] :
                    ['qr_code', 'code_128', 'ean_13', 'ean_8', 'code_39', 'upc_a', 'upc_e'];
                
                const barcodeDetector = new BarcodeDetector({ formats });
                
                async function detect() {
                    // ç¡®ä¿åªæœ‰å½“å‰æ´»è·ƒå¼•æ“ç»§ç»­è¿è¡Œ
                    if (!scanEngines.native.active || activeEngine !== 'native') {
                        return;
                    }
                    
                    // æ€§èƒ½ä¼˜åŒ–ï¼šèŠ‚æµæ‰«æ
                    const now = Date.now();
                    if (now - lastScanTime < SCAN_THROTTLE) {
                        animationId = requestAnimationFrame(detect);
                        return;
                    }
                    
                    try {
                        const barcodes = await barcodeDetector.detect(scanVideo);
                        if (barcodes.length > 0) {
                            lastScanTime = now;
                            const format = barcodes[0].format || detectBarcodeFormat(barcodes[0].rawValue);
                            handleScanResult(barcodes[0].rawValue, 'Native API', format);
                            // åœ¨æ‰¹é‡æ‰«ææ¨¡å¼ä¸‹ä¸åœæ­¢æ‰«æ
                            if (!batchScanning) {
                                return;
                            }
                        }
                    } catch (error) {
                        if (scanEngines.native.active) {
                            console.error('åŸç”ŸAPIæ£€æµ‹é”™è¯¯:', error);
                        }
                    }
                    
                    animationId = requestAnimationFrame(detect);
                }
                
                detect();
                showToast('åŸç”ŸAPI æ‰«æå·²å¯åŠ¨', 'success');
            } catch (error) {
                console.error('åŸç”ŸAPIå¯åŠ¨å¤±è´¥:', error);
                
                // é‡ç½®çŠ¶æ€
                scanEngines.native.active = false;
                if (activeEngine === 'native') {
                    activeEngine = null;
                }
                
                showToast('åŸç”ŸAPIå¯åŠ¨å¤±è´¥ï¼Œåˆ‡æ¢åˆ°Zxing', 'error');
                changeScanMethod('zxing');
            }
        }
        
        // åˆ‡æ¢æ‰«ææ–¹æ³•
        function changeScanMethod(method) {
            // é˜²æ­¢åˆ‡æ¢åˆ°ç›¸åŒæ–¹æ³•
            if (currentScanMethod === method) {
                console.log('å·²ç»æ˜¯å½“å‰æ‰«ææ–¹æ³•:', method);
                return;
            }
            
            console.log('åˆ‡æ¢æ‰«ææ–¹æ³•ä»', currentScanMethod, 'åˆ°', method);
            currentScanMethod = method;
            
            // æ›´æ–°UI
            document.querySelectorAll('.scan-method-option').forEach(option => {
                option.classList.remove('active');
            });
            const targetOption = document.querySelector(`input[value="${method}"]`);
            if (targetOption) {
                targetOption.parentElement.classList.add('active');
            }
            
            // åœæ­¢å½“å‰æ‰«æ
            stopCurrentScanning();
            
            // æ˜¾ç¤ºåˆ‡æ¢æç¤º
            const methodNames = {
                'jsqr': 'jsQR',
                'zxing': 'Zxing',
                'native': 'åŸç”ŸAPI'
            };
            
            showToast(`æ­£åœ¨åˆ‡æ¢åˆ° ${methodNames[method]} æ‰«æå¼•æ“...`, 'success');
            
            // é‡æ–°å¼€å§‹æ‰«æ
            if (scanning) {
                // ä½¿ç”¨æ›´çŸ­çš„å»¶è¿Ÿï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰äº†æ›´å¥½çš„å¼•æ“ç®¡ç†
                setTimeout(() => {
                    startScanning();
                }, 200);
            }
        }
        
        // åœæ­¢å½“å‰æ‰«æ
        function stopCurrentScanning() {
            console.log('åœæ­¢å½“å‰æ‰«æï¼Œæ–¹æ³•:', currentScanMethod);
            
            // åœæ­¢æŒ‡å®šçš„å¼•æ“
            if (currentScanMethod && scanEngines[currentScanMethod] && scanEngines[currentScanMethod].active) {
                if (scanEngines[currentScanMethod].stopFunction) {
                    scanEngines[currentScanMethod].stopFunction();
                }
            }
            
            // æ¢å¤UIçŠ¶æ€
            scanVideo.style.display = 'block';
        }
        
        // ç¿»è½¬æ‘„åƒå¤´
        async function flipCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            
            try {
                // åœæ­¢å½“å‰æ‰«æ
                stopCurrentScanning();
                
                // å¯åŠ¨æ–°çš„æ‘„åƒå¤´
                await startCamera(currentCamera);
                
                // æ ¹æ®æ‘„åƒå¤´ç±»å‹è®¾ç½®é»˜è®¤é•œåƒçŠ¶æ€
                if (currentCamera === 'user') {
                    // å‰ç½®æ‘„åƒå¤´é»˜è®¤å¼€å¯é•œåƒ
                    mirrorState = true;
                    scanVideo.style.transform = 'scaleX(-1)';
                    showToast(`å·²åˆ‡æ¢åˆ°å‰ç½®æ‘„åƒå¤´ï¼ˆé»˜è®¤é•œåƒï¼‰`, 'success');
                } else {
                    // åç½®æ‘„åƒå¤´é»˜è®¤å…³é—­é•œåƒ
                    mirrorState = false;
                    scanVideo.style.transform = 'scaleX(1)';
                    showToast(`å·²åˆ‡æ¢åˆ°åç½®æ‘„åƒå¤´ï¼ˆé»˜è®¤ä¸é•œåƒï¼‰`, 'success');
                }
            } catch (error) {
                console.error('ç¿»è½¬æ‘„åƒå¤´å¤±è´¥:', error);
                showToast('ç¿»è½¬æ‘„åƒå¤´å¤±è´¥', 'error');
            }
        }
        
        // åˆ‡æ¢é—ªå…‰ç¯
        async function toggleFlash() {
            try {
                const track = scanVideo.srcObject.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if (capabilities.torch) {
                    const currentTorch = track.getSettings().torch;
                    await track.applyConstraints({
                        advanced: [{ torch: !currentTorch }]
                    });
                    flashState = !flashState;
                    showToast(flashState ? 'é—ªå…‰ç¯å·²å¼€å¯' : 'é—ªå…‰ç¯å·²å…³é—­', 'success');
                } else {
                    showToast('è®¾å¤‡ä¸æ”¯æŒé—ªå…‰ç¯', 'error');
                }
            } catch (error) {
                console.error('åˆ‡æ¢é—ªå…‰ç¯å¤±è´¥:', error);
                showToast('åˆ‡æ¢é—ªå…‰ç¯å¤±è´¥', 'error');
            }
        }
        
        // åˆ‡æ¢é•œåƒç¿»è½¬
        function toggleMirror() {
            mirrorState = !mirrorState;
            if (mirrorState) {
                scanVideo.style.transform = 'scaleX(-1)';
                showToast('é•œåƒå·²å¼€å¯', 'success');
            } else {
                scanVideo.style.transform = 'scaleX(1)';
                showToast('é•œåƒå·²å…³é—­', 'success');
            }
        }
        
        // åˆ‡æ¢æ¡å½¢ç æ¨¡å¼
        function toggleBarcodeMode() {
            barcodeMode = !barcodeMode;
            const btn = document.getElementById('barcode-mode-btn');
            const title = document.getElementById('scan-title');
            const tips = document.getElementById('scan-tips');
            
            if (barcodeMode) {
                btn.classList.add('active');
                title.textContent = 'å…¨å±æ¡å½¢ç æ‰«æ';
                tips.textContent = 'æ¡å½¢ç æ‰«ææ¨¡å¼ - å°†æ¡å½¢ç å¯¹å‡†å±å¹•ä»»æ„ä½ç½®';
                showToast('å·²åˆ‡æ¢åˆ°æ¡å½¢ç æ¨¡å¼', 'success');
                
                // å½“å‰é»˜è®¤å·²ç»æ˜¯åŸç”ŸAPIï¼Œæ— éœ€åˆ‡æ¢
            } else {
                btn.classList.remove('active');
                title.textContent = 'å…¨å±æ‰«ç ';
                tips.textContent = 'å…¨å±æ‰«ææ¨¡å¼ - å°†äºŒç»´ç å¯¹å‡†å±å¹•ä»»æ„ä½ç½®';
                showToast('å·²åˆ‡æ¢åˆ°äºŒç»´ç æ¨¡å¼', 'success');
            }
            
            // é‡æ–°å¯åŠ¨æ‰«æä»¥åº”ç”¨æ–°æ¨¡å¼
            if (scanning) {
                stopCurrentScanning();
                setTimeout(() => {
                    startScanning();
                }, 200);
            }
        }
        
        // å¼€å§‹æ‰¹é‡æ‰«æ
        function startBatchScan() {
            batchScanning = true;
            batchScanResults = [];
            lastBatchScanTime = 0; // é‡ç½®æœ€åæ‰«ææ—¶é—´
            
            const btn = document.getElementById('batch-scan-btn');
            const title = document.getElementById('scan-title');
            const tips = document.getElementById('scan-tips');
            
            btn.classList.add('active');
            title.textContent = 'æ‰¹é‡æ‰«ç æ¨¡å¼';
            tips.textContent = 'æ‰¹é‡æ‰«ç æ¨¡å¼ - è¿ç»­æ‰«æå¤šä¸ªäºŒç»´ç /æ¡å½¢ç ï¼Œå®Œæˆåç‚¹å‡»åœæ­¢æŒ‰é’®';
            
            showToast('æ‰¹é‡æ‰«æå·²å¼€å§‹ï¼Œè¯·è¿ç»­æ‰«æå¤šä¸ªç ', 'success');
            
            // æ›´æ–°æŒ‰é’®åŠŸèƒ½ä¸ºåœæ­¢æ‰¹é‡æ‰«æ
            btn.setAttribute('onclick', 'stopBatchScan()');
            btn.title = 'åœæ­¢æ‰¹é‡æ‰«æ';
            
            // é‡æ–°å¯åŠ¨æ‰«æä»¥åº”ç”¨æ‰¹é‡æ¨¡å¼
            if (scanning) {
                stopCurrentScanning();
                setTimeout(() => {
                    startScanning();
                }, 200);
            }
        }
        
        // åœæ­¢æ‰¹é‡æ‰«æ
        function stopBatchScan() {
            batchScanning = false;
            
            const btn = document.getElementById('batch-scan-btn');
            const title = document.getElementById('scan-title');
            const tips = document.getElementById('scan-tips');
            
            btn.classList.remove('active');
            title.textContent = 'å…¨å±æ‰«ç ';
            tips.textContent = 'å…¨å±æ‰«ææ¨¡å¼ - å°†äºŒç»´ç å¯¹å‡†å±å¹•ä»»æ„ä½ç½®';
            
            // æ¢å¤æŒ‰é’®åŠŸèƒ½ä¸ºå¼€å§‹æ‰¹é‡æ‰«æ
            btn.setAttribute('onclick', 'startBatchScan()');
            btn.title = 'æ‰¹é‡è¯†åˆ«';
            
            // å¤„ç†æ‰¹é‡æ‰«æç»“æœ
            if (batchScanResults.length > 0) {
                // å»é‡
                const uniqueResults = [...new Set(batchScanResults)];
                
                // ç”Ÿæˆç»“æœæ–‡æœ¬
                const batchResultText = `æ‰¹é‡æ‰«æç»“æœ (${uniqueResults.length}ä¸ª):\n\n${uniqueResults.join('\n\n')}`;
                
                // æ˜¾ç¤ºç»“æœ
                closeScanModal();
                displayResult(batchResultText, 'æ‰¹é‡æ‰«æ');
                
                showToast(`æ‰¹é‡æ‰«æå®Œæˆï¼Œå…±è¯†åˆ« ${uniqueResults.length} ä¸ªç `, 'success');
            } else {
                showToast('æ‰¹é‡æ‰«æå·²åœæ­¢ï¼Œæœªè¯†åˆ«åˆ°ä»»ä½•ç ', 'error');
            }
            
            // æ¸…ç©ºæ‰¹é‡æ‰«æç»“æœ
            batchScanResults = [];
        }
        
        // æµ‹è¯•æ‰€æœ‰æ‰«æå¼•æ“
        async function testScanEngines() {
            const engines = ['jsqr', 'zxing', 'native'];
            const results = [];
            
            showToast('å¼€å§‹æµ‹è¯•æ‰€æœ‰æ‰«æå¼•æ“...', 'success');
            
            for (const engine of engines) {
                try {
                    console.log(`æµ‹è¯• ${engine} å¼•æ“...`);
                    changeScanMethod(engine);
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©å¼•æ“åˆå§‹åŒ–
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    results.push(`${engine}: âœ… åˆå§‹åŒ–æˆåŠŸ`);
                } catch (error) {
                    console.error(`${engine} æµ‹è¯•å¤±è´¥:`, error);
                    results.push(`${engine}: âŒ åˆå§‹åŒ–å¤±è´¥ - ${error.message}`);
                }
            }
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            console.log('æ‰«æå¼•æ“æµ‹è¯•ç»“æœ:', results);
            showToast('æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…', 'success');
            
            // æ¢å¤åˆ°åŸç”ŸAPI
            changeScanMethod('native');
        }
        
        // å…³é—­æ‰«ææ¨¡æ€æ¡†
        function closeScanModal() {
            const modal = document.getElementById('scan-modal');
            modal.classList.remove('active');
            
            // åœæ­¢æ‰€æœ‰å¼•æ“
            Object.keys(scanEngines).forEach(engine => {
                if (scanEngines[engine].active && scanEngines[engine].stopFunction) {
                    scanEngines[engine].stopFunction();
                }
            });
            
            // é‡ç½®æ´»è·ƒå¼•æ“
            activeEngine = null;
            
            // åœæ­¢è§†é¢‘æµ
            if (scanVideo.srcObject) {
                scanVideo.srcObject.getTracks().forEach(track => track.stop());
                scanVideo.srcObject = null;
            }
            
            // ç¡®ä¿è§†é¢‘å…ƒç´ å¯è§
            scanVideo.style.display = 'block';
            
            // é‡ç½®UIçŠ¶æ€
            document.getElementById('permission-area').style.display = 'none';
            document.getElementById('scan-tips').style.display = 'block';
            
            // é‡ç½®æ‰¹é‡æ‰«æçŠ¶æ€
            if (batchScanning) {
                batchScanning = false;
                batchScanResults = [];
                
                const btn = document.getElementById('batch-scan-btn');
                btn.classList.remove('active');
                btn.setAttribute('onclick', 'startBatchScan()');
                btn.title = 'æ‰¹é‡è¯†åˆ«';
                
                const title = document.getElementById('scan-title');
                const tips = document.getElementById('scan-tips');
                title.textContent = 'å…¨å±æ‰«ç ';
                tips.textContent = 'å…¨å±æ‰«ææ¨¡å¼ - å°†äºŒç»´ç å¯¹å‡†å±å¹•ä»»æ„ä½ç½®';
            }
            
            // é‡ç½®çŠ¶æ€å˜é‡
            scanning = false;
            
            console.log('æ‰«ææ¨¡æ€æ¡†å·²å…³é—­ï¼Œæ‰€æœ‰èµ„æºå·²æ¸…ç†');
        }
        
        // å¤„ç†æ‰«æç»“æœ
        function handleScanResult(data, method = '', format = '') {
            currentFormat = format || detectBarcodeFormat(data);
            const isBarcode = currentFormat !== 'QR Code';
            
            // æ‰¹é‡æ‰«ææ¨¡å¼å¤„ç†
            if (batchScanning) {
                const now = Date.now();
                
                // é˜²æŠ–æœºåˆ¶ï¼šé˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤æ‰«æ
                if (now - lastBatchScanTime < BATCH_SCAN_COOLDOWN) {
                    return; // åœ¨å†·å´æ—¶é—´å†…ï¼Œå¿½ç•¥æ‰«æç»“æœ
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰«æè¿‡è¿™ä¸ªç 
                if (!batchScanResults.includes(data)) {
                    batchScanResults.push(data);
                    lastBatchScanTime = now; // æ›´æ–°æœ€åæ‰«ææ—¶é—´
                    showToast(`å·²æ·»åŠ ç¬¬ ${batchScanResults.length} ä¸ªç  (${method})`, 'success');
                    
                    // æŒ¯åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                } else {
                    showToast('è¿™ä¸ªç å·²ç»æ‰«æè¿‡äº†', 'error');
                    
                    // æŒ¯åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                }
                
                // ç»§ç»­æ‰«æï¼Œä¸å…³é—­æ¨¡æ€æ¡†
                return;
            }
            
            // æ™®é€šæ‰«ææ¨¡å¼å¤„ç†
            showToast(`æ‰«ææˆåŠŸï¼(${method})`, 'success');
            
            // åœ¨å…³é—­æ¨¡æ€æ¡†å‰æ•è·å½“å‰è§†é¢‘å¸§ä½œä¸ºé¢„è§ˆ
            let previewImageSrc = null;
            if (scanVideo.readyState === scanVideo.HAVE_ENOUGH_DATA) {
                const previewCanvas = document.createElement('canvas');
                const previewContext = previewCanvas.getContext('2d');
                
                // ä½¿ç”¨é€‚åˆé¢„è§ˆåŒºçš„å°ºå¯¸ï¼Œä¿æŒè§†é¢‘çš„å®½é«˜æ¯”
                const maxWidth = 160;
                const maxHeight = 160;
                const videoWidth = scanVideo.videoWidth;
                const videoHeight = scanVideo.videoHeight;
                
                let width = videoWidth;
                let height = videoHeight;
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                previewCanvas.width = width;
                previewCanvas.height = height;
                
                // æ ¹æ®é•œåƒçŠ¶æ€è°ƒæ•´ç»˜åˆ¶
                if (mirrorState) {
                    previewContext.scale(-1, 1);
                    previewContext.drawImage(scanVideo, -width, 0, width, height);
                } else {
                    previewContext.drawImage(scanVideo, 0, 0, width, height);
                }
                
                previewImageSrc = previewCanvas.toDataURL('image/jpeg', 0.9);
            }
            
            closeScanModal();
            
            // æ˜¾ç¤ºæ‰«æé¢„è§ˆ
            displayScanPreview(previewImageSrc);
            
            // æ˜¾ç¤ºç»“æœ
            displayResult(data, currentFormat);
        }
        
        // æ˜¾ç¤ºæ‰«æé¢„è§ˆ
        function displayScanPreview(imageSrc = null) {
            const previewContent = document.getElementById('preview-content');
            
            if (imageSrc) {
                previewContent.innerHTML = `
                    <div class="image-preview" style="position: relative; z-index: 1;">
                        <img src="${imageSrc}" class="preview-image" alt="æ‰«æé¢„è§ˆ" style="cursor: pointer; position: relative; z-index: 1;" onclick="reanalyzePreviewImage('${imageSrc}')" title="ç‚¹å‡»å›¾ç‰‡é‡è¯†åˆ«">
                        <div style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; pointer-events: none; display: flex; align-items: center; gap: 6px; white-space: nowrap; z-index: 2;" class="preview-hint">
                            ğŸ“· ç‚¹å‡»å›¾ç‰‡é‡è¯†åˆ«
                        </div>
                    </div>
                `;
            } else {
                previewContent.innerHTML = `
                    <div class="scan-preview">
                        <div class="preview-icon">ğŸ“·</div>
                        <p>é¢„è§ˆåŒº</p>
                    </div>
                `;
            }
        }
        
        // æ‰“å¼€ä¸Šä¼ æ¨¡æ€æ¡†
        function openUploadModal(type) {
            currentUploadType = type;
            const modal = document.getElementById('upload-modal');
            const title = document.getElementById('upload-title');
            const uploadArea = document.getElementById('upload-area');
            const uploadIcon = uploadArea.querySelector('.upload-icon');
            
            title.textContent = type === 'file' ? 'ä¸Šä¼ æ–‡ä»¶' : 'ä¸Šä¼ å›¾ç‰‡';
            uploadIcon.textContent = type === 'file' ? 'ğŸ“' : 'ğŸ–¼ï¸';
            
            resetUpload();
            modal.classList.add('active');
        }
        
        // å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
        function closeUploadModal() {
            const modal = document.getElementById('upload-modal');
            modal.classList.remove('active');
            resetUpload();
            clearExternalPreview();
        }
        
        // æ¸…é™¤å¤–éƒ¨é¢„è§ˆ
        function clearExternalPreview() {
            const previewContent = document.getElementById('preview-content');
            previewContent.innerHTML = `
                <div class="preview-placeholder">
                    <div class="preview-icon">ğŸ“·</div>
                    <p>é¢„è§ˆåŒº</p>
                </div>
            `;
        }
        
        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('preview-image');
                img.src = e.target.result;
                
                // æ˜¾ç¤ºå¤–éƒ¨é¢„è§ˆ
                displayExternalPreview(e.target.result, file.name);
                
                document.getElementById('upload-area').classList.add('hidden');
                document.getElementById('preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        // æ˜¾ç¤ºå¤–éƒ¨é¢„è§ˆ
        function displayExternalPreview(imageSrc, fileName) {
            const previewContent = document.getElementById('preview-content');
            previewContent.innerHTML = `
                <div class="image-preview">
                    <img src="${imageSrc}" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                </div>
            `;
        }
        
        // åˆ†æå›¾ç‰‡ï¼ˆä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„åº“ï¼‰
        async function analyzeImage() {
            const img = document.getElementById('preview-image');
            
            // åˆ›å»ºä¸´æ—¶canvasæ¥å¤„ç†å›¾ç‰‡
            const tempCanvas = document.createElement('canvas');
            const tempContext = tempCanvas.getContext('2d');
            
            img.onload = async function() {
                tempCanvas.width = img.naturalWidth;
                tempCanvas.height = img.naturalHeight;
                tempContext.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                
                const imageData = tempContext.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                
                // å°è¯•æ‰€æœ‰å¯ç”¨çš„åº“
                let result = null;
                let method = '';
                let format = '';
                
                // 1. å°è¯•jsQR
                try {
                    const jsqrResult = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    if (jsqrResult) {
                        result = jsqrResult.data;
                        method = 'jsQR';
                        format = detectBarcodeFormat(result);
                    }
                } catch (e) {
                    console.error('jsQRåˆ†æå¤±è´¥:', e);
                }
                
                // 2. å°è¯•Zxing
                if (!result) {
                    try {
                        const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(tempCanvas);
                        const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
                        const multiFormatReader = new ZXing.MultiFormatReader();
                        const zxingResult = multiFormatReader.decode(binaryBitmap);
                        if (zxingResult) {
                            result = zxingResult.getText();
                            method = 'Zxing';
                            format = detectBarcodeFormat(result);
                        }
                    } catch (e) {
                        console.error('Zxingåˆ†æå¤±è´¥:', e);
                    }
                }
                
                // 3. å°è¯•åŸç”ŸAPI
                if (!result && 'BarcodeDetector' in window) {
                    try {
                        const barcodeDetector = new BarcodeDetector({
                            formats: ['qr_code', 'code_128', 'ean_13', 'ean_8', 'code_39', 'upc_a', 'upc_e']
                        });
                        const barcodes = await barcodeDetector.detect(tempCanvas);
                        if (barcodes.length > 0) {
                            result = barcodes[0].rawValue;
                            method = 'Native API';
                            format = barcodes[0].format || detectBarcodeFormat(result);
                        }
                    } catch (e) {
                        console.error('åŸç”ŸAPIåˆ†æå¤±è´¥:', e);
                    }
                }
                
                if (result) {
                    showToast(`è¯†åˆ«æˆåŠŸï¼(${method})`, 'success');
                    
                    // ä¿å­˜å½“å‰é¢„è§ˆå†…å®¹
                    const currentPreview = document.getElementById('preview-content').innerHTML;
                    
                    closeUploadModal();
                    
                    // æ¢å¤é¢„è§ˆå†…å®¹
                    document.getElementById('preview-content').innerHTML = currentPreview;
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayResult(result, format);
                } else {
                    showToast('æœªæ£€æµ‹åˆ°äºŒç»´ç æˆ–æ¡å½¢ç ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«æœ‰æ•ˆçš„ç ', 'error');
                }
            };
            
            // å¦‚æœå›¾ç‰‡å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥å¤„ç†
            if (img.complete) {
                img.onload();
            }
        }
        
        // é‡ç½®ä¸Šä¼ 
        function resetUpload() {
            document.getElementById('file-input').value = '';
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('preview-container').classList.add('hidden');
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }
        
        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
            
            document.body.removeChild(textArea);
        }
        
        // æ˜¾ç¤ºToastæç¤º
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            
            // æ ¹æ®ç±»å‹æ·»åŠ å›¾æ ‡
            let icon = '';
            switch(type) {
                case 'success':
                    icon = 'ğŸŒŸ ';
                    break;
                case 'error':
                    icon = 'âš ï¸ ';
                    break;
                default:
                    icon = 'ğŸ’¡ ';
            }
            
            toast.innerHTML = `<span style="display: flex; align-items: center; gap: 6px;">${icon}${message}</span>`;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
        function displayResult(result, format = '') {
            if (!result) return;
            
            // ä¿å­˜å½“å‰ç»“æœåˆ°æ’¤é”€æ ˆ
            if (currentResult) {
                undoStack.push(currentResult);
            }
            
            // ç´¯åŠ ç»“æœè€Œä¸æ˜¯è¦†ç›–
            if (currentResult) {
                currentResult = currentResult + '\n\n' + result;
            } else {
                currentResult = result;
            }
            redoStack = []; // æ¸…ç©ºé‡åšæ ˆ
            
            // æ›´æ–°ç»“æœæ˜¾ç¤º
            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = `<div class="result-text">${escapeHtml(currentResult)}</div>`;
            
            // æ˜¾ç¤ºæ ¼å¼æ ‡ç­¾
            if (format) {
                const formatBadge = document.getElementById('result-format');
                formatBadge.textContent = format;
                formatBadge.style.display = 'inline-block';
                
                // æ ¹æ®æ ¼å¼è®¾ç½®æ ·å¼
                if (format === 'QR Code') {
                    formatBadge.className = 'format-badge qrcode';
                } else {
                    formatBadge.className = 'format-badge barcode';
                }
            }
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory(result, format);
            
            // ä¿å­˜å†å²åˆ°æœ¬åœ°å­˜å‚¨
            saveHistory();
        }
        
        // æ¸…é™¤ç»“æœ
        function clearResult() {
            if (currentResult) {
                undoStack.push(currentResult);
            }
            
            currentResult = '';
            redoStack = [];
            currentFormat = '';
            
            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = '<p class="result-placeholder">æš‚æ— è¯†åˆ«ç»“æœ</p>';
            
            // éšè—æ ¼å¼æ ‡ç­¾
            const formatBadge = document.getElementById('result-format');
            formatBadge.style.display = 'none';
            
            showToast('å·²æ¸…é™¤ç»“æœ', 'success');
        }
        
        // æ’¤é”€
        function undoResult() {
            if (undoStack.length === 0) {
                showToast('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ', 'error');
                return;
            }
            
            redoStack.push(currentResult);
            currentResult = undoStack.pop();
            
            const resultContent = document.getElementById('result-content');
            if (currentResult) {
                resultContent.innerHTML = `<div class="result-text">${escapeHtml(currentResult)}</div>`;
            } else {
                resultContent.innerHTML = '<p class="result-placeholder">æš‚æ— è¯†åˆ«ç»“æœ</p>';
            }
            
            showToast('å·²æ’¤é”€', 'success');
        }
        
        // åæ’¤é”€
        function redoResult() {
            if (redoStack.length === 0) {
                showToast('æ²¡æœ‰å¯é‡åšçš„æ“ä½œ', 'error');
                return;
            }
            
            undoStack.push(currentResult);
            currentResult = redoStack.pop();
            
            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = `<div class="result-text">${escapeHtml(currentResult)}</div>`;
            
            showToast('å·²é‡åš', 'success');
        }
        
        // å¤åˆ¶ç»“æœ
        function copyResult() {
            if (!currentResult) {
                showToast('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'error');
                return;
            }
            
            copyToClipboard(currentResult);
        }
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(result, format = '') {
            const historyItem = {
                text: result,
                format: format,
                time: new Date().toLocaleString()
            };
            
            resultHistory.unshift(historyItem);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (resultHistory.length > 50) {
                resultHistory = resultHistory.slice(0, 50);
            }
            
            updateHistoryDisplay();
        }
        
        // æ›´æ–°å†å²æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyContent = document.getElementById('history-content');
            
            if (resultHistory.length === 0) {
                historyContent.innerHTML = '<p class="history-placeholder">æš‚æ— è¯†åˆ«å†å²</p>';
                return;
            }
            
            let historyHTML = '';
            resultHistory.forEach((item, index) => {
                const formatBadge = item.format ? 
                    `<span class="format-badge ${item.format === 'QR Code' ? 'qrcode' : 'barcode'}">${item.format}</span>` : '';
                
                historyHTML += `
                    <div class="history-item">
                        <div class="history-header" onclick="toggleHistoryItem(${index})">
                            <span class="history-toggle">></span>
                            <div class="history-preview">${escapeHtml(item.text.substring(0, 50))}${item.text.length > 50 ? '...' : ''}${formatBadge}</div>
                            <div class="history-time">${item.time}</div>
                        </div>
                        <div class="history-content-detail" id="history-detail-${index}">
                            <div class="history-full-text">${escapeHtml(item.text)}</div>
                        </div>
                    </div>
                `;
            });
            
            historyContent.innerHTML = historyHTML;
        }
        
        // åˆ‡æ¢å†å²è®°å½•å±•å¼€/å…³é—­
        function toggleHistoryItem(index) {
            const detailElement = document.getElementById(`history-detail-${index}`);
            const toggleElement = detailElement.previousElementSibling.querySelector('.history-toggle');
            
            if (detailElement.style.display === 'block') {
                detailElement.style.display = 'none';
                toggleElement.textContent = '>';
                toggleElement.style.transform = 'rotate(0deg)';
            } else {
                detailElement.style.display = 'block';
                toggleElement.textContent = '>';
                toggleElement.style.transform = 'rotate(90deg)';
            }
        }
        
        // ä¿å­˜å†å²åˆ°æœ¬åœ°å­˜å‚¨
        function saveHistory() {
            try {
                localStorage.setItem('qr_history', JSON.stringify(resultHistory));
            } catch (e) {
                console.error('ä¿å­˜å†å²å¤±è´¥:', e);
            }
        }
        
        // æ¸…é™¤å†å²è®°å½•
        function clearHistory() {
            if (resultHistory.length === 0) {
                showToast('æ²¡æœ‰å¯æ¸…é™¤çš„å†å²è®°å½•', 'error');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                resultHistory = [];
                updateHistoryDisplay();
                saveHistory();
                showToast('å†å²è®°å½•å·²æ¸…é™¤', 'success');
            }
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            try {
                const saved = localStorage.getItem('qr_history');
                if (saved) {
                    resultHistory = JSON.parse(saved);
                    updateHistoryDisplay();
                }
            } catch (e) {
                console.error('åŠ è½½å†å²å¤±è´¥:', e);
            }
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // ä»æ‰«ææ¨¡æ€æ¡†é€‰æ‹©å›¾ç‰‡
        function selectImageFromScan() {
            document.getElementById('scan-image-input').click();
        }
        
        // ä»æ‰«ææ¨¡æ€æ¡†é€‰æ‹©æ–‡ä»¶
        function selectFileFromScan() {
            document.getElementById('scan-file-input').click();
        }
        
        // å¤„ç†æ‰«ææ¨¡æ€æ¡†å†…çš„å›¾ç‰‡é€‰æ‹©
        function handleScanImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processSelectedFile(file, 'å›¾ç‰‡');
            }
        }
        
        // å¤„ç†æ‰«ææ¨¡æ€æ¡†å†…çš„æ–‡ä»¶é€‰æ‹©
        function handleScanFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processSelectedFile(file, 'æ–‡ä»¶');
            }
        }
        
        // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
        async function processSelectedFile(file, sourceType) {
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            showToast(`æ­£åœ¨åˆ†æ${sourceType}...`, 'success');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageSrc = e.target.result; // ä¿å­˜å›¾ç‰‡æ•°æ®URL
                
                // åˆ›å»ºä¸´æ—¶å›¾åƒå…ƒç´ 
                const img = new Image();
                img.onload = async function() {
                    // åˆ›å»ºä¸´æ—¶canvasæ¥å¤„ç†å›¾ç‰‡
                    const tempCanvas = document.createElement('canvas');
                    const tempContext = tempCanvas.getContext('2d');
                    
                    tempCanvas.width = img.naturalWidth;
                    tempCanvas.height = img.naturalHeight;
                    tempContext.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    const imageData = tempContext.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // å°è¯•æ‰€æœ‰å¯ç”¨çš„åº“è¿›è¡Œè¯†åˆ«
                    let result = null;
                    let method = '';
                    let format = '';
                    
                    // 1. å°è¯•å½“å‰é€‰ä¸­çš„æ‰«ææ–¹æ³•
                    switch (currentScanMethod) {
                        case 'jsqr':
                            try {
                                const jsqrResult = jsQR(imageData.data, imageData.width, imageData.height, {
                                    inversionAttempts: "dontInvert",
                                });
                                if (jsqrResult) {
                                    result = jsqrResult.data;
                                    method = 'jsQR';
                                    format = detectBarcodeFormat(result);
                                }
                            } catch (e) {
                                console.error('jsQRåˆ†æå¤±è´¥:', e);
                            }
                            break;
                            
                        case 'zxing':
                            try {
                                const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(tempCanvas);
                                const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
                                const multiFormatReader = new ZXing.MultiFormatReader();
                                const zxingResult = multiFormatReader.decode(binaryBitmap);
                                if (zxingResult) {
                                    result = zxingResult.getText();
                                    method = 'Zxing';
                                    format = detectBarcodeFormat(result);
                                }
                            } catch (e) {
                                console.error('Zxingåˆ†æå¤±è´¥:', e);
                            }
                            break;
                            
                        case 'native':
                            if ('BarcodeDetector' in window) {
                                try {
                                    const formats = barcodeMode ? 
                                        ['code_128', 'ean_13', 'ean_8', 'code_39', 'upc_a', 'upc_e', 'itf', 'codabar'] :
                                        ['qr_code', 'code_128', 'ean_13', 'ean_8', 'code_39', 'upc_a', 'upc_e'];
                                    
                                    const barcodeDetector = new BarcodeDetector({ formats });
                                    const barcodes = await barcodeDetector.detect(tempCanvas);
                                    if (barcodes.length > 0) {
                                        result = barcodes[0].rawValue;
                                        method = 'Native API';
                                        format = barcodes[0].format || detectBarcodeFormat(result);
                                    }
                                } catch (e) {
                                    console.error('åŸç”ŸAPIåˆ†æå¤±è´¥:', e);
                                }
                            }
                            break;
                    }
                    
                    // å¦‚æœå½“å‰æ–¹æ³•å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
                    if (!result) {
                        // å°è¯•åŸç”ŸAPI
                        if (!result && 'BarcodeDetector' in window && currentScanMethod !== 'native') {
                            try {
                                const formats = ['qr_code', 'code_128', 'ean_13', 'ean_8', 'code_39', 'upc_a', 'upc_e'];
                                const barcodeDetector = new BarcodeDetector({ formats });
                                const barcodes = await barcodeDetector.detect(tempCanvas);
                                if (barcodes.length > 0) {
                                    result = barcodes[0].rawValue;
                                    method = 'Native API';
                                    format = barcodes[0].format || detectBarcodeFormat(result);
                                }
                            } catch (e) {
                                console.error('åŸç”ŸAPIåˆ†æå¤±è´¥:', e);
                            }
                        }
                        
                        // å°è¯•Zxing
                        if (!result && currentScanMethod !== 'zxing') {
                            try {
                                const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(tempCanvas);
                                const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
                                const multiFormatReader = new ZXing.MultiFormatReader();
                                const zxingResult = multiFormatReader.decode(binaryBitmap);
                                if (zxingResult) {
                                    result = zxingResult.getText();
                                    method = 'Zxing';
                                    format = detectBarcodeFormat(result);
                                }
                            } catch (e) {
                                console.error('Zxingåˆ†æå¤±è´¥:', e);
                            }
                        }
                        
                        // å°è¯•jsQR
                        if (!result && currentScanMethod !== 'jsqr') {
                            try {
                                const jsqrResult = jsQR(imageData.data, imageData.width, imageData.height, {
                                    inversionAttempts: "dontInvert",
                                });
                                if (jsqrResult) {
                                    result = jsqrResult.data;
                                    method = 'jsQR';
                                    format = detectBarcodeFormat(result);
                                }
                            } catch (e) {
                                console.error('jsQRåˆ†æå¤±è´¥:', e);
                            }
                        }
                    }
                    
                    if (result) {
                        showToast(`${sourceType}è¯†åˆ«æˆåŠŸï¼(${method})`, 'success');
                        closeScanModal();
                        
                        // æ˜¾ç¤ºé€‰æ‹©çš„å›¾ç‰‡é¢„è§ˆ
                        displayScanPreview(imageSrc);
                        
                        // æ˜¾ç¤ºç»“æœ
                        displayResult(result, format);
                    } else {
                        showToast(`${sourceType}ä¸­æœªæ£€æµ‹åˆ°äºŒç»´ç æˆ–æ¡å½¢ç ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«æœ‰æ•ˆçš„ç `, 'error');
                    }
                };
                
                img.src = imageSrc;
            };
            
            reader.readAsDataURL(file);
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
            event.target.value = '';
        }
        
        // é‡æ–°è¯†åˆ«é¢„è§ˆå›¾ç‰‡
        async function reanalyzePreviewImage(imageSrc) {
            showToast('æ­£åœ¨é‡æ–°è¯†åˆ«é¢„è§ˆå›¾ç‰‡...', 'success');
            
            // åˆ›å»ºä¸´æ—¶å›¾åƒå…ƒç´ 
            const img = new Image();
            img.onload = async function() {
                // åˆ›å»ºä¸´æ—¶canvasæ¥å¤„ç†å›¾ç‰‡
                const tempCanvas = document.createElement('canvas');
                const tempContext = tempCanvas.getContext('2d');
                
                tempCanvas.width = img.naturalWidth;
                tempCanvas.height = img.naturalHeight;
                tempContext.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                
                const imageData = tempContext.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                
                // å°è¯•æ‰€æœ‰å¯ç”¨çš„åº“è¿›è¡Œè¯†åˆ«
                let result = null;
                let method = '';
                let format = '';
                
                // å°è¯•åŸç”ŸAPI
                if ('BarcodeDetector' in window) {
                    try {
                        const formats = ['qr_code', 'code_128', 'ean_13', 'ean_8', 'code_39', 'upc_a', 'upc_e'];
                        const barcodeDetector = new BarcodeDetector({ formats });
                        const barcodes = await barcodeDetector.detect(tempCanvas);
                        if (barcodes.length > 0) {
                            result = barcodes[0].rawValue;
                            method = 'Native API';
                            format = barcodes[0].format || detectBarcodeFormat(result);
                        }
                    } catch (e) {
                        console.error('åŸç”ŸAPIåˆ†æå¤±è´¥:', e);
                    }
                }
                
                // å°è¯•Zxing
                if (!result) {
                    try {
                        const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(tempCanvas);
                        const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
                        const multiFormatReader = new ZXing.MultiFormatReader();
                        const zxingResult = multiFormatReader.decode(binaryBitmap);
                        if (zxingResult) {
                            result = zxingResult.getText();
                            method = 'Zxing';
                            format = detectBarcodeFormat(result);
                        }
                    } catch (e) {
                        console.error('Zxingåˆ†æå¤±è´¥:', e);
                    }
                }
                
                // å°è¯•jsQR
                if (!result) {
                    try {
                        const jsqrResult = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });
                        if (jsqrResult) {
                            result = jsqrResult.data;
                            method = 'jsQR';
                            format = detectBarcodeFormat(result);
                        }
                    } catch (e) {
                        console.error('jsQRåˆ†æå¤±è´¥:', e);
                    }
                }
                
                if (result) {
                    showToast(`é‡æ–°è¯†åˆ«æˆåŠŸï¼(${method})`, 'success');
                    // æ˜¾ç¤ºç»“æœ
                    displayResult(result, format);
                } else {
                    showToast('é¢„è§ˆå›¾ç‰‡ä¸­æœªæ£€æµ‹åˆ°äºŒç»´ç æˆ–æ¡å½¢ç ', 'error');
                }
            };
            
            img.src = imageSrc;
        }
        
        // ç›‘å¬ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeScanModal();
                closeUploadModal();
            }
        });
    </script>
</body>
</html>
